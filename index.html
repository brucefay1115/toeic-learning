<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOEIC AI Tutor</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5856D6">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./assets/icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/styles.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3KMB363K29"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3KMB363K29');
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

    <header>
        <h1>TOEIC AI Tutor</h1>
        <div class="header-right">
            <button class="settings-btn" id="btnSettings"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 21v-7M4 10V3M12 21v-9M12 8V3M20 21v-5M20 12V3M1 14h6M9 8h6M17 16h6"/></svg></button>
        </div>
    </header>

    <!-- TAB: Learn -->
    <div id="tabLearn" class="container">
        <div id="emptyState" class="empty-state">
            <div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div>
            <p>還沒有學習內容</p>
            <p>開始你的第一個練習吧！可選文章、口說對話或模擬考試。</p>
            <button class="cta-btn">開始練習</button>
        </div>
        <div id="learningArea" class="hidden">
            <div class="article-card">
                <div class="article-meta" id="articleMeta"></div>
                <div id="articleContainer"></div>
                <div class="toggle-btn-row">
                    <button class="translate-toggle-btn" id="btnToggleEn">隱藏英文</button>
                    <button class="translate-toggle-btn" id="btnToggleZh">顯示中文</button>
                </div>
            </div>
            <h3 class="section-title">核心單字 Vocabulary</h3>
            <div class="vocab-grid" id="vocabList"></div>
            <h3 class="section-title" id="phraseSectionTitle">常用片語 Key Phrases</h3>
            <div id="phraseList"></div>
        </div>
        <div class="hidden" id="speakingSessionView">
            <div class="speaking-status" id="speakingStatus">尚未開始對話</div>
            <div class="practice-inline-actions">
                <button class="wm-btn speaking-stop-btn speaking-primary-btn" id="btnStopSpeaking">停止對話</button>
                <button class="wm-btn secondary speaking-stop-btn speaking-secondary-btn" id="btnSpeakingBack">返回主題設定</button>
            </div>
            <div class="speaking-log" id="speakingLog"></div>
        </div>
        <div class="exam-shell hidden" id="examShell">
            <div class="exam-meta" id="examMeta"></div>
            <div class="exam-content" id="examContent"></div>
            <div class="exam-actions" id="examActions"></div>
            <button class="wm-btn secondary exam-back-btn" id="btnExamBack">返回考試設定</button>
        </div>
    </div>

    <!-- TAB: Practice -->
    <div id="tabPractice" class="container hidden">
        <div class="practice-container">
            <h2>練習模式</h2>
            <p class="subtitle">選擇文章、口說或模擬考試</p>

            <div class="practice-mode-switch" id="practiceModeSwitch">
                <button class="practice-mode-btn active" data-mode="article">文章練習</button>
                <button class="practice-mode-btn" data-mode="speaking">口說對話</button>
                <button class="practice-mode-btn" data-mode="exam">模擬考試</button>
            </div>

            <div class="practice-mode-panel" id="practicePanelArticle">
                <h3 class="practice-label">目標分數</h3>
                <p class="practice-note">根據你的多益程度選擇適合難度</p>
                <div class="score-selector" id="scoreSelector"></div>

                <div class="practice-section">
                    <h3 class="practice-label">自訂主題（選填）</h3>
                    <input type="text" class="topic-input" id="customTopic" placeholder="例如：機場報到、商業會議、餐廳點餐...">
                </div>
                <div class="practice-section">
                    <h3 class="practice-label">朗讀語音</h3>
                    <div class="voice-selector" id="voiceSelector"></div>
                </div>
                <button class="generate-btn" id="btnGenerate">開始學習</button>
            </div>

            <div class="practice-mode-panel hidden" id="practicePanelSpeaking">
                <div id="speakingConfigView">
                    <h3 class="practice-label">主題（可選一個）</h3>
                    <div class="topic-preset-group" id="speakingPresetGroup">
                        <button class="topic-chip active" data-topic="機場通關與登機">機場通關與登機</button>
                        <button class="topic-chip" data-topic="商務會議與簡報">商務會議與簡報</button>
                        <button class="topic-chip" data-topic="電話客服與問題排除">電話客服與問題排除</button>
                        <button class="topic-chip" data-topic="報價談判與合約討論">報價談判與合約討論</button>
                        <button class="topic-chip" data-topic="飯店訂房與改期">飯店訂房與改期</button>
                        <button class="topic-chip" data-topic="餐廳訂位與抱怨處理">餐廳訂位與抱怨處理</button>
                        <button class="topic-chip" data-topic="跨部門合作與進度追蹤">跨部門合作與進度追蹤</button>
                        <button class="topic-chip" data-topic="面試與自我介紹">面試與自我介紹</button>
                    </div>
                    <div class="practice-section">
                        <h3 class="practice-label">自訂主題（選填）</h3>
                        <input type="text" class="topic-input" id="speakingCustomTopic" placeholder="例如：談判報價、面試自我介紹、訂房問題處理...">
                    </div>
                    <button class="generate-btn" id="btnStartSpeaking">開始口說對話</button>
                </div>
            </div>

            <div class="practice-mode-panel hidden" id="practicePanelExam">
                <div id="examConfigView">
                    <h3 class="practice-label">考試設定</h3>
                    <p class="practice-note">依目前目標分數生成四類題目：聽力 3 題 / 閱讀 3 篇 3 題 / 單字 3 題 / 文法 3 題</p>
                    <div class="score-selector" id="examScoreSelector"></div>
                    <button class="generate-btn" id="btnStartExam">開始模擬考試</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Vocab -->
    <div id="tabVocab" class="container hidden">
        <div class="vocab-tab-header">
            <h3 class="section-title">單字本 Vocabulary</h3>
            <span class="vocab-tab-count" id="vocabCount">0 個單字</span>
        </div>
        <div id="srsReviewEntry"></div>
        <div id="savedWordsList"></div>
    </div>

    <!-- TAB: History -->
    <div id="tabHistory" class="container hidden">
        <h3 class="section-title" style="margin-top: 10px;">學習紀錄 History</h3>
        <div id="historyList"></div>
        <button id="btnClearHistory" style="font-size:13px; color:red; background:none; border:none; margin-top:10px;">清除全部紀錄</button>
    </div>

    <!-- TAB: About -->
    <div id="tabAbout" class="container hidden">
        <div class="about-page">
            <div class="about-icon-circle">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <h2 class="about-name">Bruce Yang</h2>
            <p class="about-bio">TOEIC AI Tutor 開發者<br>熱愛用技術解決學習問題，希望讓每個人都能輕鬆學英文。<br>如果這個工具對你有幫助，歡迎給我一點鼓勵！</p>

            <div class="about-links">
                <a href="https://www.facebook.com/bruce.yang.94" target="_blank" rel="noopener" class="about-link-card">
                    <span class="about-link-icon fb"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></span>
                    <span class="about-link-text">
                        <span class="about-link-title">Facebook</span>
                        <span class="about-link-desc">追蹤我的動態</span>
                    </span>
                    <span class="about-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></span>
                </a>
                <a href="https://www.linkedin.com/in/chun-hsiang-yang-b17238165" target="_blank" rel="noopener" class="about-link-card">
                    <span class="about-link-icon linkedin"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></span>
                    <span class="about-link-text">
                        <span class="about-link-title">LinkedIn</span>
                        <span class="about-link-desc">了解我的專業背景</span>
                    </span>
                    <span class="about-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></span>
                </a>
                <a href="https://github.com/brucefay1115/toeic-learning" target="_blank" rel="noopener" class="about-link-card">
                    <span class="about-link-icon github"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></span>
                    <span class="about-link-text">
                        <span class="about-link-title">GitHub</span>
                        <span class="about-link-desc">查看開源程式碼，歡迎 Star ⭐</span>
                    </span>
                    <span class="about-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></span>
                </a>
                <a href="mailto:brucefay1115@gmail.com" class="about-link-card">
                    <span class="about-link-icon email"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg></span>
                    <span class="about-link-text">
                        <span class="about-link-title">Bug 回報 / 建議</span>
                        <span class="about-link-desc">brucefay1115@gmail.com</span>
                    </span>
                    <span class="about-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></span>
                </a>
                <a href="https://buymeacoffee.com/brucefay110" target="_blank" rel="noopener" class="about-link-card coffee">
                    <span class="about-link-icon coffee"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg></span>
                    <span class="about-link-text">
                        <span class="about-link-title">Buy Me a Coffee</span>
                        <span class="about-link-desc">請我喝杯咖啡，支持持續開發 ☕</span>
                    </span>
                    <span class="about-link-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></span>
                </a>
            </div>

            <p class="about-version" id="appVersion"></p>
            <p class="about-footer">Made with ❤️ by Bruce Yang</p>
        </div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" data-tab="learn">
            <span class="tab-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></span>
            <span class="tab-label">學習</span>
        </button>
        <button class="tab-btn" data-tab="practice">
            <span class="tab-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></span>
            <span class="tab-label">練習</span>
        </button>
        <button class="tab-btn" data-tab="vocab">
            <span class="tab-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg></span>
            <span class="tab-label">單字本</span>
        </button>
        <button class="tab-btn" data-tab="history">
            <span class="tab-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
            <span class="tab-label">紀錄</span>
        </button>
        <button class="tab-btn" data-tab="about">
            <span class="tab-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
            <span class="tab-label">關於</span>
        </button>
    </nav>

    <div class="player-bar hidden" id="playerBar">
        <button class="play-btn" id="btnPlayPause"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6 3 20 12 6 21 6 3"/></svg></button>
        <div class="progress-container" id="progressContainer"><div class="progress-fill" id="progressBar"></div></div>
        <button class="speed-btn" id="btnSpeed">1.0x</button>
    </div>

    <div class="word-modal" id="wordModal">
        <div class="wm-header">
            <div class="wm-word" id="wmWord">Word</div>
            <button class="large-speaker" id="btnWordAudio"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></button>
        </div>
        <div class="wm-meta"><span id="wmPos">n.</span> <span id="wmIpa">/IPA/</span></div>
        <div class="wm-def" id="wmDef">Definition</div>
        <div style="font-style: italic; color: #666; margin-bottom: 6px; display: flex; align-items: center;" id="wmEx">
            <span id="wmExText">Example.</span>
            <button class="mini-speaker" id="wmExSpeakBtn" style="margin-left:5px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></button>
        </div>
        <div style="font-size: 14px; color: var(--text-sub); margin-bottom: 20px;" id="wmExZh" class="hidden"></div>
        <div id="wmActionArea" class="wm-actions"></div>
        <button class="wm-btn secondary">關閉</button>
    </div>

    <div class="modal-overlay" id="keyModal">
        <div class="modal-card">
            <h3>設定 Gemini API</h3>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-guide-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.78 7.78 5.5 5.5 0 0 1 7.78-7.78Zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                <span>點此取得 Google API Key<br><span style="font-size:11px; font-weight:400;">(需登入 Google 帳號)</span></span>
            </a>
            <div class="input-group">
                <input type="password" id="apiKeyInput" placeholder="Paste API Key here...">
                <button type="button" class="api-clear-btn" id="btnClearApiKey">一鍵清除</button>
            </div>
            <button class="generate-btn" id="btnSaveApiKey" style="margin: 10px 0 0;">儲存</button>
            <button class="wm-btn secondary" id="btnCloseKeyModal" style="margin-top: 8px; display: none;">關閉</button>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">Key 僅儲存於本地裝置 (IndexedDB)，不會備份到 Google Drive</p>

            <div class="cloud-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
                    雲端備份 Cloud Backup
                </h4>
                <p style="font-size:12px; color:#999; margin: 0 0 10px;">雲端僅同步學習紀錄與單字，不包含 API Key。</p>
                <div id="cloudAuthArea">
                    <button class="cloud-login-btn" id="btnCloudLogin">
                        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
                        使用 Google 帳號登入
                    </button>
                </div>
                <div id="cloudUserArea" class="hidden">
                    <div class="cloud-user-info">
                        <div class="cloud-user-avatar" id="cloudAvatar">G</div>
                        <div class="cloud-user-detail">
                            <div class="cloud-user-name" id="cloudUserName">User</div>
                            <div class="cloud-user-email" id="cloudUserEmail">user@gmail.com</div>
                        </div>
                    </div>
                    <div class="cloud-actions">
                        <button class="cloud-action-btn primary" id="btnBackupNow">立即備份</button>
                        <button class="cloud-action-btn" id="btnRestore">從雲端還原</button>
                        <button class="cloud-action-btn danger" id="btnCloudLogout">登出</button>
                    </div>
                    <div class="cloud-last-sync" id="cloudLastSync"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="srs-overlay hidden" id="srsOverlay">
        <div class="srs-content">
            <div class="srs-top-bar">
                <button class="srs-close-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                <span class="srs-progress-text" id="srsProgressText">1 / 9</span>
                <span class="srs-phase-badge" id="srsPhaseBadge">英文 → 中文</span>
            </div>
            <div class="srs-question-area" id="srsQuestionArea"></div>
            <div class="srs-options-area" id="srsOptionsArea"></div>
        </div>
    </div>

    <audio id="mainAudio"></audio>

<script type="module" src="./assets/js/main.js"></script>
</body>
</html>
